---
import { getCollection, type CollectionEntry } from "astro:content";

import BaseLayout from "@/layouts/BaseLayout.astro";
import SeoPage from "@/components/SeoPage.astro";
import Post from "@/components/Post.astro";

const posts = await getCollection("blog");

// Render all posts unsorted - client-side JS will handle sorting/filtering
const allPosts = posts;

// Styling classes matching the site's aesthetic
const selectClasses = [
  // Base styling with rounded corners
  "px-4 py-3 rounded-lg outline-none focus:ring-4 transition-colors border",
  
  // DaisyUI semantic colors
  "bg-base-100 text-base-content border-base-300",
  "focus:border-base-300/70 focus:ring-base-300/70",
  
  // Custom select styling
  "appearance-none bg-no-repeat bg-right pr-10",
  "cursor-pointer"
].join(" ");

const inputClasses = [
  // Base styling with rounded corners
  "px-4 py-3 rounded-lg outline-none focus:ring-4 transition-colors border",
  
  // DaisyUI semantic colors
  "bg-base-100 text-base-content border-base-300",
  "placeholder:text-base-content/60",
  "focus:border-base-300/70 focus:ring-base-300/70"
].join(" ");

const labelClasses = [
  "text-sm font-medium text-base-content/80"
].join(" ");
---

<BaseLayout>
  <SeoPage slot="head" title="Archive" description="Browse all posts" />
  <main>
    <section class="py-8">
      <h1 class="text-3xl font-bold text-primary-content">Archive</h1>
      <p class="mt-1 text-base-content/70"><span id="archive-count">{allPosts.length}</span> posts</p>

      <div id="archive-controls" class="mt-8 p-6 bg-base-100 rounded-2xl ring-2 ring-base-300/70 shadow-sm">
        <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
          <div class="flex flex-col gap-2 min-w-0">
            <label for="sort" class={labelClasses}>Sort by</label>
            <div class="relative">
              <select id="sort" class={selectClasses} style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 4 5\'><path fill=\'%23666\' d=\'M2 0L0 2h4zm0 5L0 3h4z\'/></svg>')">
                <option value="default">Default (featured & date)</option>
                <option value="title-asc">Title (A–Z)</option>
                <option value="title-desc">Title (Z–A)</option>
                <option value="date-newest">Date (newest)</option>
                <option value="date-oldest">Date (oldest)</option>
              </select>
            </div>
          </div>
          
          <div class="flex flex-col gap-2 flex-1 min-w-0">
            <label for="q" class={labelClasses}>Filter posts</label>
            <input 
              id="q" 
              placeholder="Search by title, content, or tags..." 
              class={`${inputClasses} w-full`}
            />
          </div>
        </div>
      </div>
    </section>

    <ul id="archive-list" class="flex flex-col gap-4 list-none px-0 py-8">
      {allPosts.map((post) => (<Post post={post} />))}
    </ul>
    <script is:inline>
      // Client-side filtering and sorting
      (function () {
        const controls = document.getElementById('archive-controls');
        if (!controls) return;
        
        const input = document.getElementById('q');
        const select = document.getElementById('sort');
        const list = document.getElementById('archive-list');
        const countEl = document.getElementById('archive-count');
        
        if (!input || !select || !list) return;

        const items = Array.from(list.children);
        
        // Initialize from URL params
        const params = new URLSearchParams(window.location.search);
        const initialQuery = params.get('q') || '';
        const initialSort = params.get('sort') || 'default';
        
        input.value = initialQuery;
        select.value = initialSort;

        function sortItems(sortType) {
          const sortedItems = [...items].sort((a, b) => {
            switch (sortType) {
              case 'title-asc':
                return (a.dataset.title || '').localeCompare(b.dataset.title || '');
              case 'title-desc':
                return (b.dataset.title || '').localeCompare(a.dataset.title || '');
              case 'date-newest':
                return new Date(b.dataset.date || 0).getTime() - new Date(a.dataset.date || 0).getTime();
              case 'date-oldest':
                return new Date(a.dataset.date || 0).getTime() - new Date(b.dataset.date || 0).getTime();
              case 'default':
              default:
                // Default sort: prioritize sortOrder, then by date (oldest first)
                const aOrder = parseInt(a.dataset.sortOrder) || null;
                const bOrder = parseInt(b.dataset.sortOrder) || null;
                if (aOrder !== null && bOrder !== null) {
                  return aOrder - bOrder;
                }
                if (aOrder !== null) return -1;
                if (bOrder !== null) return 1;
                return new Date(a.dataset.date || 0).getTime() - new Date(b.dataset.date || 0).getTime();
            }
          });
          
          // Re-append items in sorted order
          sortedItems.forEach(item => list.appendChild(item));
        }

        function applyFilter() {
          const query = (input.value || '').trim().toLowerCase();
          const sortType = select.value || 'default';
          
          // First sort items
          sortItems(sortType);
          
          // Then filter
          let visible = 0;
          for (const li of items) {
            const hay = (li.textContent || '').toLowerCase();
            const show = query === '' || hay.includes(query);
            li.style.display = show ? '' : 'none';
            if (show) visible++;
          }
          
          if (countEl) countEl.textContent = String(visible);
          
          // Update URL without reload
          const newParams = new URLSearchParams();
          if (query) newParams.set('q', query);
          if (sortType !== 'default') newParams.set('sort', sortType);
          
          const newUrl = `${window.location.pathname}${newParams.toString() ? '?' + newParams.toString() : ''}`;
          window.history.replaceState({}, '', newUrl);
        }

        // Event listeners
        input.addEventListener('input', applyFilter);
        select.addEventListener('change', applyFilter);
        
        // Initialize
        applyFilter();
      })();
    </script>
  </main>
</BaseLayout>

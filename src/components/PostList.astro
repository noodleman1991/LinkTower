---
import { getCollection, type CollectionEntry } from "astro:content";

import { SITE } from "@/siteConfig";

import Post from "@/components/Post.astro";
import CustomLink from "@/components/CustomLink.astro";

const posts = await getCollection("blog");

const defaultSort = (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) => {
  const aOrder = a.data.sortOrder;
  const bOrder = b.data.sortOrder;
  if (aOrder != null && bOrder != null) {
    return aOrder - bOrder;
  }
  if (aOrder != null) return -1;
  if (bOrder != null) return 1;
  // Fallback: by publication date (oldest first)
  return a.data.publicationDate.valueOf() - b.data.publicationDate.valueOf();
};

const sorted = [...posts].sort(defaultSort);

const limit = SITE.blogHomePostLimit ?? 5;
const limited = sorted.slice(0, limit);
const hasMore = sorted.length > limit;
---

<h2 class="pt-8 sm:pt-12 pb-8 text-3xl font-semibold text-center text-base-content">Posts</h2>
<ul class="flex flex-col gap-4 list-none px-0 pb-12">
  {limited.map((post: CollectionEntry<"blog">) => (
    <Post post={post} />
  ))}
  {hasMore && (
    <CustomLink link={{
      id: "view-all",
      title: "View all posts",
      description: "Browse the full archive of posts.",
      url: "/archive",
      icon: "lucide:archive"
    }} />
  )}
</ul>
